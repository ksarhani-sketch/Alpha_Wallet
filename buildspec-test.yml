version: 0.2

env:
  variables:
    FLUTTER_SDK_URL: https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.24.3-stable.tar.xz

phases:
  install:
    commands:
      - set -e
      - echo "=== Install base packages ==="
      - apt-get update -y
      - apt-get install -y curl git unzip xz-utils libglu1-mesa
      - echo "=== Download & setup Flutter SDK ==="
      - curl -L -o flutter.tar.xz "$FLUTTER_SDK_URL"
      - tar -xf flutter.tar.xz
      - export PATH="$PWD/flutter/bin:$PATH"
      - git config --global --add safe.directory "$PWD/flutter"
      - flutter --version || true
      - flutter config --enable-web || true

      - echo "=== Locate Flutter app directory ==="
      - |
        if [ -f clients/flutter/pubspec.yaml ]; then
          APP_DIR="clients/flutter"
        elif [ -f pubspec.yaml ]; then
          APP_DIR="."
        else
          echo "ERROR: Could not find pubspec.yaml in expected locations."
          find . -maxdepth 3 -type f -name pubspec.yaml -print
          exit 1
        fi
        echo "$APP_DIR" > .appdir
        echo "Using APP_DIR=$APP_DIR"

      - echo "=== Fetch project dependencies ==="
      - APP_DIR="$(cat .appdir)"
      - (cd "$APP_DIR" && flutter pub get)

  pre_build:
    commands:
      - echo "=== Pre-build complete ==="

  build:
    commands:
      - set -e
      - echo "=== Run unit/widget tests (if present) ==="
      - APP_DIR="$(cat .appdir)"
      - |
        if [ -d "$APP_DIR/test" ]; then
          (cd "$APP_DIR" && flutter test --coverage)
        else
          echo "No test directory at $APP_DIR/test â€” skipping tests"
          # Do not fail the build on infos/warnings:
          (cd "$APP_DIR" && flutter analyze --no-fatal-infos --no-fatal-warnings) || true
        fi

      - echo "=== Build web bundle ==="
      - (cd "$APP_DIR" && flutter build web --release)

artifacts:
  files:
    - '**/*'
  base-directory: clients/flutter/build/web
